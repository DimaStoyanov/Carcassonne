# Server API


Для обмена сообщениями между клиентом  и сервером используем `POST` запросы, а также `Websocket`.
Все ответы в формате  `JSON`.

Любой ответ содержит поля `code`, `type` и `description`. Ответ с типом `TOKEN`, `EMAIL` содержит также поле `token`
и `email` соответственно.

Примеры ответов сервера:
```
  {"code":301,"type":"DEFAULT","description":"Not unique username"}
  {"token":"buWMAFBbsy1UqM13mIlWLRRCQDn8wuGy","code":200,"type":"TOKEN","description":"Save this token to local
   storage of browser.It must be attached to the socket header and also as a parameter of a requests associated 
   with account management"}
```


### Реализованные сервлеты
* `/sign_in`
* `/sign_up`
* `/verify`
* `/reset_password`
* `/set_password`
* `/send_email`


При локальном запуске сервера все сервлеты работают по адресу `http://<hostIP>:8080/<servlet_name>`  
Для любых сервлетов наложено ограничение на количество запросов в секунду от одного пользователя - не более 3 запросов в секунду. 

Возможные ответы сервера:


code | description                                    | type    | HTTP code
-----|------------------------------------------------|---------|-----------
100  | Need confirm email: sdima11101@gmail.com       | DEFAULT | 200
101  | Account successfully confirmed                 | DEFAULT | 200
102  | Password successfully changed                  | DEFAULT | 200
103  | Letter successfully sent                       | EMAIL   | 200
200  | Save this token to local storage of browser... | TOKEN   | 200
300  | Some parameters are missed                     | DEFAULT | 400
301  | Not unique username                            | DEFAULT | 400
302  | Not unique email address                       | DEFAULT | 400
303  | Invalid email address                          | DEFAULT | 400
304  | Incorrect confirmationKey                      | DEFAULT | 400
305  | Incorrect username/password                    | DEFAULT | 400
306  | Incorrect token                                | DEFAULT | 400
307  | Player with that username/email does not exist | DEFAULT | 400
308  | Account has already been verified              | DEFAULT | 400
309  | Account does not verified                      | EMAIL   | 400
310  | Letter has already sent. Wait 30 seconds.      | EMAIL   | 400
311  | Incorrect parameter "type"                     | DEFAULT | 400
313  | Too much requests per second                   | DEFAULT | 400
314  | Internal server error                          | DEFAULT | 500

Note: Не стоит опираться на `description` при написании клиента, они могут отличаться для одной ошибки в разных сервлетах. 
Лучше использовать `code`. `type` нужен лишь для того, чтобы узнать есть ли дополнительные поля в ответе. 

1. `/sign_up` - сервлет для регистрации новых пользователей. При успехе отправляет на email пользователя письмо с потверждением аккаунта. 
Принимает обязательные параметры `username, password, email`. `username` и `email` должны быть уникальными.    
Сервлет может вернуть сообщения с кодом `100`, `300`, `301`, `302`, `303`, `313`, `314`    
При этом регистрация происходит по следующей схеме:
    * Клиент посылает `POST` запрос `/sign_up`
    * Сервер отвечает клиенту, если все ок, сервер отправляет письмо пользователю.
    * Пользователь проверяет почту и открывает ссылку в письме, эта ссылка ведет на страницу клиента,
    например `https://DimaStoyanov.github.io/client/verify`
    * Клиент обрабатывает эту страницу и посылает `POST` запрос `/verify` c параметром  confirmationKey, взятым из 
    параметров запроса пользователя (т.е. в письме содержится ссылка на `GET` запрос с параметром `confirmationKey`, 
    ее нужно переадресовать)
    * Сервер отвечает на запрос, если все ок, сервер потверждает аккаунт.
    
 

2. `/sign_in` - сервлет для авторизации. Пользователь должен быть зарегестрирован и его аккаунт должен быть потвержден. 
В случае успеха возвращает токен, который необходимо сохранить в `Local storage` браузера и использовать 
в дальнейших операциях управление аккаунтом и для открытия веб сокета (указать в заголовке). 
Принимает обязательные параметры `username`,  `password`.  
Сервлет может вернуть сообщения с кодом  `200`, `300`, `305`, `309`, `313`, `314` 

3. `/verify` - сервлет для потверждения аккаунта. Принимает обязательный параметр `confirmationKey`.
В случае успеха пользователь в дальнейшем сможет зайти в свой аккаунт.  
Сервлет может вернуть сообщения с кодом `101`, `300`, `304`, `313`, `314`

4. `/reset_password` - сервлет для запроса сброса пароля. Принимает в качестве параметров `username` или `password`. 
Достаточно задать хотя бы один из них. В случае успеха отправляет email письмо с дальнейшими инструкциями для игрока.
Нельзя сменить пароль, если аккаунт еще не потвержден.  
Работает по схеме аналогичной схеме авторизации, а именно:
    * Клиент посылает `POST` запрос `/reset_password`
    * Сервер отвечает клиенту, если все ок, сервер посылает пользователю письмо.
    * Пользователь проверяет почту, открывает ссылку из письма, которая ведет на страницу клиента, 
    например `https://DimaStoyanov.github.io/client/reset_password?token=...`
    * На этой странице пользователь должен ввести новый пароль (желательно дважды, и проверить их совпадение)
    * Клиент отправляет `POST` запрос `/set_password`, где в качестве параметров указывает новый пароль и токен,
    полученный из запроса пользователя
    * Сервер отвечает на запрос, в случае успеха меняет пароль аккаунта  
Сервлет может вернуть сообщения с кодом `103`, `300`, `307`, `309`, `310`, `313`, `314`

4. `/set_password` - сервлет для смены пароля. Принимает обязательные параметры `password`, `token`.
В случае успеха меняет пароль пользователя.  
Сервлет может вернуть сообщения с кодом `102`, `300`, `306`, `309`, `313`, `314`

5. `/send_email` - сервлет для повторной отправки электронных писем. Например пользователю не приходит письмо с потверждением аккаунта 
или письмо для сброса пароля, но повторно сделав запрос `/sign_up` или `/reset_password` он получит ошибку. В таком случае нужно 
делать запрос  `/send_email`. Принимает параметры `type`, `username`, `email`. Нужно обязательно указать `type` и 
хотя бы один из двух оставшихся параметров. `type` может быть либо `sign_up` либо `reset_password`. 
На отправку электронных писем наложено ограничение - каждый пользователь может не чаще, чем раз в 30 секунд 
запрашивать новое письмо.
Сервлет может вернуть сообщения с кодом `103`, `307`, `308`, `309`, `310`, `311`, `313`, `314`

